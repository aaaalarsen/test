# test.json形式の限界分析

## 概要

`preNodes`の`choice`情報により基本的な画面遷移は表現できるものの、複雑な業務ルールを持つチャットボットを実現するには依然として不十分な要素があります。

---

## preNodesで解決できること

```json
{
  "screen": 3,
  "navText": "預入金額を入力してください",
  "preNodes": [
    {
      "screen": 2,
      "choice": "預入"  // この情報で遷移元を特定可能
    }
  ]
}
```

✅ **基本的な選択肢ベースの画面遷移**  
どの選択肢からどの画面に来たかを追跡できる

---

## test.jsonで対応できない課題

### 1. 入力値による動的分岐

#### **課題の詳細**
ユーザーの入力内容に応じて異なる画面に遷移する仕組みが不足

#### **具体例：払出金額による分岐**
```json
// 現在のtest.json構造では表現不可能
{
  "screen": 4,
  "navText": "払出金額を入力してください",
  "isInputField": true
  // 問題：入力された金額値によって次の画面を決める仕組みがない
  // 19万円入力 → 確認画面へ
  // 21万円入力 → エラー画面へ
  // この分岐をどう表現する？
}
```

#### **configuration.jsonでの実装例**
```json
{
  "conditions": [
    {
      "operator": {"type": "AND", "child": [
        {"field": "payoutAmount", "value": "200000", "state": "EQUALS_LESS_THAN"}
      ]},
      "branchNo": 0  // 払出金額確認画面へ
    },
    {
      "operator": {"type": "AND", "child": [
        {"field": "payoutAmount", "value": "200000", "state": "GREATER"}
      ]},
      "branchNo": 1  // 手続き不可画面へ
    }
  ]
}
```

---

### 2. 複数条件の組み合わせ判定

#### **課題の詳細**
AND/OR演算子を使った複数条件の組み合わせが表現できない

#### **具体例：振込の海外送金チェック**
```json
// configuration.jsonの実装
{
  "conditions": [
    {
      "operator": {
        "type": "AND",
        "child": [
          {"field": "transactionType", "value": "transfer", "state": "EQUALS"},
          {"field": "recipientsCountry", "value": "Others", "state": "EQUALS"}
        ]
      }
    }
  ]
}

// test.jsonでは表現不可能
{
  "screen": 5,
  "conditions": [
    {
      "field": "transactionType",
      "value": "transfer", 
      "state": "EQUALS"
    }
    // 問題：recipientsCountryとのAND条件が書けない
    // 1つの条件しか表現できない
  ]
}
```

---

### 3. 実行時変数の管理

#### **課題の詳細**
ユーザーの入力値を保存し、後の条件判定で参照する仕組みが不明

#### **具体例：入力値の保存と参照**
```json
// ユーザーが「20万円」と入力した場合
// この値をどこに保存し、後の条件判定でどう使う？

{
  "screen": 4,
  "navText": "払出金額を入力してください", 
  "isInputField": true
  // 問題：入力値の保存先が定義されていない
  // domainDataとの連携方法が不明
}

{
  "screen": 5,
  "conditions": [
    {
      "field": "payoutAmount",  // この値はどこから取得？
      "value": "200000",
      "state": "GREATER"
    }
  ]
  // 問題：fieldの値をどこから参照するかが不明
}
```

#### **必要な仕組み**
- 入力値の一時保存領域
- `domainData`との連携機能
- 実行時変数の参照メカニズム

---

### 4. 条件による次画面の決定メカニズム

#### **課題の詳細**
選択肢の内容に応じて異なる画面に遷移する仕組みが不足

#### **具体例：金融機関選択後の分岐**
```json
// configuration.jsonの実装
{
  "conditions": [
    {
      "field": "financialInstitution",
      "value": "others",
      "state": "NOT_EQUALS",
      "branchNo": 0  // 支店選択画面へ
    },
    {
      "field": "financialInstitution", 
      "value": "others",
      "state": "EQUALS",
      "branchNo": 1  // 金融機関検索画面へ
    }
  ]
}

// test.jsonでは次画面の決定方法が不明
{
  "screen": 6,
  "navText": "金融機関を選択してください",
  "choices": ["みずほ銀行", "三菱UFJ銀行", "その他"],
  // 問題：「その他」を選んだ場合と、他を選んだ場合で
  // 異なる画面に遷移する仕組みがない
}
```

---

### 5. 動的な画面フローの制御

#### **課題の詳細**
条件による画面スキップや柔軟なルート変更ができない

#### **具体例：条件による画面スキップ**
```json
// シナリオ：振込で日本国内の場合、国選択画面をスキップして金融機関選択へ
// 海外の場合は「手続き不可」画面へ

// test.jsonでは表現不可能
// 画面の順序が固定的で、条件による柔軟なルート変更ができない
```

#### **必要な機能**
- 条件による画面スキップ
- 動的なルート変更
- 並列フローの合流処理

---

### 6. エラー状態と正常終了の区別

#### **課題の詳細**
フローの終了条件や終了タイプが定義されていない

#### **具体例：手続き不可画面の処理**
```json
{
  "screen": 99,
  "navText": "ご希望のお取引は当システムでは行っていただけません。窓口をご利用ください。",
  "choices": [],
  // 問題：この画面が正常終了なのかエラーなのかが分からない
  // フローの終了条件が定義されていない
}
```

#### **必要な情報**
- 終了タイプ（正常終了/エラー終了/中断）
- 終了条件の定義
- 後続処理の指示

---

### 7. 実行時の状態管理

#### **チャットボット実行中に必要な情報**

| 項目 | 説明 | test.jsonでの対応状況 |
|------|------|---------------------|
| 現在のユーザー入力値 | 各画面での入力内容 | ❌ 保存場所不明 |
| 選択肢の履歴 | 過去の選択内容 | ❌ 管理方法不明 |
| 条件判定用変数 | 分岐判定に使用する値 | ❌ 参照方法不明 |
| 次画面決定ロジック | 条件に基づく遷移先 | ❌ 決定方法不明 |
| エラー状態 | 異常終了の判定 | ❌ 区別不可能 |

---

## 結論

### ✅ **test.jsonで実現可能なこと**
- 基本的な選択肢ベースのチャット
- 線形な質問応答フロー
- 単純な前画面からの遷移

### ❌ **test.jsonで実現困難なこと**
- **動的な条件分岐**（入力値による分岐）
- **複数条件の組み合わせ判定**（AND/OR演算）
- **実行時変数の管理**（入力値の保存と参照）
- **柔軟なフロー制御**（画面スキップ、ルート変更）
- **状態管理**（エラー処理、終了条件）

### 📋 **推奨される改善策**
金融業務のような複雑なルールを持つチャットボットを実現するには、以下の要素を追加した新しいJSON形式が必要：

1. **実行時変数管理システム**
2. **複合条件判定エンジン**
3. **動的画面遷移メカニズム**
4. **状態管理とエラーハンドリング**
5. **フロー終了条件の定義**

これらの機能なしでは、configuration.jsonの複雑な業務フローを完全に再現することは困難です。

---

## 次のステップ

チャットボット実現のためには、test.jsonの形式を以下のように拡張することを推奨します：

### 改善されたJSON構造例
```json
{
  "nodes": [
    {
      "screen": 1,
      "type": "choice",
      "navText": "取引種別を選択してください",
      "choices": [...],
      "transitions": [
        {
          "choice": "預入",
          "nextScreen": 2,
          "setValue": {"transactionType": "deposit"}
        }
      ]
    },
    {
      "screen": 2,
      "type": "input", 
      "navText": "金額を入力してください",
      "fieldName": "amount",
      "validation": {
        "type": "number",
        "min": 1,
        "max": 1000000
      },
      "transitions": [
        {
          "condition": {
            "operator": "AND",
            "rules": [
              {"field": "amount", "operator": "GREATER", "value": 200000}
            ]
          },
          "nextScreen": 99
        },
        {
          "condition": {"operator": "DEFAULT"},
          "nextScreen": 3
        }
      ]
    }
  ],
  "variables": {},
  "endScreens": [99, 100]
}
```

この拡張により、configuration.jsonの複雑な業務フローを完全に再現できるチャットボットの実現が可能になります。