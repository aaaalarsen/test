# 音声割り込み対応チャットボットアプリ システム設計書

## 1. システム概要

### 1.1 プロジェクト背景
- **現状：** Reactで構築されたWebアプリケーションのチャットボット
- **課題：** 端末出力音（アバター音声）がユーザー音声と誤認される問題
- **目標：** 業務用iPadで高精度な音声割り込み対応を実現

### 1.2 基本要件
- **プラットフォーム：** 業務用iPad専用
- **主要機能：** アバター音声出力中のユーザー音声割り込み検出
- **制約条件：** 
  - App Store規約準拠
  - 完全無料（時間制限なし）
  - 既存Web資産の最大限活用

### 1.3 技術方針
- **アーキテクチャ：** ハイブリッド構成（ネイティブ + WebView）
- **開発言語：** Swift（ネイティブ部分）+ React/JavaScript（WebView部分）
- **最小ネイティブ実装：** App Store規約の最低限要件のみ

## 2. システム構成

### 2.1 全体アーキテクチャ
```
┌─────────────────────────────────────┐
│           ネイティブ層               │
├─────────────────────────────────────┤
│ • 音声入力処理                       │
│ • 音声分離・エコーキャンセレーション   │
│ • 音声認識                          │
│ • [未決定] 音声出力                  │
│ • WebView Bridge通信                │
│ • マイク権限管理                     │
└─────────────────────────────────────┘
                    ↑↓
┌─────────────────────────────────────┐
│            WebView層                │
├─────────────────────────────────────┤
│ • 既存Reactアプリケーション           │
│ • チャットボットUI                   │
│ • アバター表示・制御                 │
│ • ビジネスロジック                   │
│ • [未決定] WebSpeech API音声出力     │
└─────────────────────────────────────┘
```

### 2.2 データフロー
```
音声入力 → 音声分離 → 音声認識 → WebView送信 → UI更新
    ↑         ↑         ↑
ネイティブ  ネイティブ  ネイティブ

[音声出力] ← WebView ← ビジネスロジック
    ↑
[未決定：WebView or ネイティブ]
```

## 3. 未決定事項と候補比較

### 3.1 音声出力方式（未決定）

#### 候補A：WebSpeech API音声出力（既存継続）
**メリット：**
- 既存コードをそのまま活用可能
- 開発工数が最小
- WebView内で完結するシンプルな構成

**デメリット：**
- iOS Voice Isolationとの連携が限定的
- 音声分離精度が20-30%低下する可能性
- ハードウェア最適化の恩恵を受けられない
- 音声出力制御の精度が限定的

**適用場面：**
- 開発工数を最小化したい場合
- プロトタイプ・検証段階

#### 候補B：AVSpeechSynthesizer（ネイティブ音声出力）
**メリット：**
- iOS Voice Isolationとの完全連携
- 最高の音声分離精度
- ハードウェアレベルでの最適化
- 音声出力の詳細制御が可能
- 低遅延・高音質

**デメリット：**
- 既存音声出力コードの改修が必要
- ネイティブ開発工数の増加
- WebView↔ネイティブ間の同期処理が複雑

**適用場面：**
- 音声割り込み精度を最重視する場合
- 長期運用での安定性を求める場合

### 3.2 音声認識・音声分離方式（未決定）

#### 候補A：iOS Voice Isolation + SFSpeechRecognizer
**メリット：**
- 最高の安定性（iOS 10以降対応）
- 長期運用実績
- 豊富なドキュメント・実装例
- 確実な動作保証

**デメリット：**
- 基本的な機能のみ
- 最新の高度機能なし

**適用場面：**
- 安定性を最重視する業務アプリ
- 幅広いiOS端末での動作が必要

#### 候補B：iOS Voice Isolation + SpeechTranscriber
**メリット：**
- 最新の高精度音声認識
- Whisperより2.2倍高速
- 長時間録音・会議に最適化
- 低遅延ライブ転写
- 完全デバイス内処理

**デメリット：**
- iOS 19以降限定
- 新しいAPIで安定性未知
- ドキュメント・実装例が少ない

**適用場面：**
- 最高精度の音声認識が必要
- 最新iOS端末での運用

#### 候補C：iOS Voice Isolation + SpeechAnalyzer + SpeechTranscriber
**メリット：**
- 最高機能（音声分析 + 認識）
- 感情・緊急度判定
- 話者識別機能
- 高度なカスタマイズ

**デメリット：**
- 実装複雑度が最高
- 処理負荷・バッテリー消費増加
- iOS 19以降限定
- オーバースペックの可能性

**適用場面：**
- 高度な音声解析が必要
- 将来的な機能拡張を見据えた場合

## 4. 推奨構成パターン

### パターン1：安定重視構成
- **音声出力：** WebSpeech API（既存）
- **音声処理：** iOS Voice Isolation + SFSpeechRecognizer
- **開発期間：** 9-12週間
- **適用場面：** 確実な動作を求める業務アプリ

### パターン2：性能重視構成
- **音声出力：** AVSpeechSynthesizer
- **音声処理：** iOS Voice Isolation + SpeechTranscriber
- **開発期間：** 12-15週間
- **適用場面：** 最高品質の音声処理が必要

### パターン3：段階的構成
- **Phase 1：** WebSpeech API + iOS Voice Isolation + SFSpeechRecognizer
- **Phase 2：** 効果測定後、必要に応じてネイティブ音声出力に移行
- **適用場面：** リスク最小化とコスト効率の両立

## 5. 開発計画

### 5.1 基本開発フェーズ
1. **基本ネイティブ実装** (2-3週間)
   - Xcodeプロジェクト作成
   - WebView表示
   - 音声権限管理

2. **音声処理実装** (3-4週間)
   - [選択した音声認識API]の統合
   - iOS Voice Isolation連携
   - リアルタイム音声認識

3. **WebView統合** (2-3週間)
   - JavaScript Bridge実装
   - 既存Webアプリとの統合
   - [音声出力方式の選択に応じた]統合作業

4. **最適化・テスト** (2週間)
   - 性能最適化
   - エラーハンドリング
   - App Store提出準備

### 5.2 意思決定ポイント
- **開発開始前：** 音声出力方式の決定
- **Phase 1完了時：** 音声認識APIの最終決定
- **Phase 3完了時：** 性能評価と最適化方針決定

## 6. 技術的制約・注意事項

### 6.1 iOS バージョン対応
- **iOS Voice Isolation：** iOS 15以降、iPhone XR/XS以降
- **SpeechTranscriber/SpeechAnalyzer：** iOS 19以降
- **SFSpeechRecognizer：** iOS 10以降

### 6.2 App Store審査対策
- 音声データのデバイス内処理完結
- WebViewが単なるブラウザラッパーでないことの証明
- プライバシーポリシーの適切な記載

### 6.3 パフォーマンス考慮事項
- バッテリー消費の最適化
- メモリ使用量の管理
- 音声処理の低遅延化

## 7. 今後の検討課題

### 7.1 即座に決定が必要な事項
1. **音声出力方式の選択** - システム設計に大きく影響
2. **音声認識APIの選択** - 開発工数と性能のトレードオフ

### 7.2 開発中に検討する事項
- 音声誤認率の許容基準設定
- 段階的機能追加の優先順位
- Android対応の将来計画

---

この設計書は、音声割り込み対応チャットボットアプリの技術的実現可能性と実装選択肢を整理したものです。未決定事項については、プロジェクトの優先度と制約条件を考慮して最適な選択を行う必要があります。