# FREIA21+ Contents Builder アドイン 作業内容書

## 1 Contents Builderアドインの概要
Contents Builder アドイン（以降 CB アドインとする）とは、インタフェースマップ定義編集とサーバ取引構成定義編集という 2 つの機能からなる Contents Builder (FREIA21+画面定義ツール) の拡張機能である。
以下にこれら 2 つの機能の概要を示す。

### インターフェースマップ定義編集
インターフェースマップ定義編集とは、FREIA21+用インタフェースマップ定義をContents Builder上で編集するための機能である。Contents BuilderにCBアドインを追加登録することで、画面の項目単位にインタフェースマップ編集内容を指定することができる。
機能概要図を以下に示す。

> **<FREIA21+ 定義>**
> [インターフェースマップ定義 (XML形式)]
>       ⇅ (XMLファイル読取り/保存)
> **Contents Builder (画面定義ツール)**
> [編集: インタフェースマップ編集アドイン]

### サーバ取引構成定義の編集
サーバ取引構成定義とは、FREIA21+のサーバ処理で取引単位に必要となる情報を定義する XML 形式のファイルである。本機能にてサーバ取引構成定義を項目単位に編集する。
機能概要図を以下に示す。

> **<FREIA21+ 定義>**
> [サーバ取引構成定義 (XML形式)]
>       ⇅ (XMLファイル読取り/保存)
> **Microsoft Excel**
> [編集: サーバ取引構成定義編集アドイン]

---

## 2 プロジェクトの背景
制御PC (FREIA21+を搭載した一般PC) がWindows10からWindows11に刷新されるのに伴い、基盤である uCosminexusClient がWin11版となり、Java11版となるためFREIA21+もJava11化する。
これに伴い関連ツールである ContentsBuilder の Win11化・Java11化をする必要があり、ContentsBuilderの拡張機能であるCBアドインもWin11化、Java11化に対応する必要がある。

## 3 前提プログラム

| 項番 | 分類 | プログラム名称 | 現行バージョン | 次期バージョン |
| :--- | :--- | :--- | :--- | :--- |
| 1 | OS | Windows | - | Windows11 |
| 2 | ソフトウェア | Microsoft Excel | - | 2021 LTSC |
| 3 | ソフトウェア | Contents Builder | - | 06-00-H-00 |
| 4 | Java 実行環境 | uCosminexus Client | - | 11-60-01 |

OSS は使用していない。

## 4 インターフェースマップ定義編集
本章では、CB アドインのインターフェースマップ定義編集機能の Java11 化・Win11 化による影響調査の内容を示す。

### 4.1 調査方針
Java 11 への移行に際し、以下の観点から影響調査を実施する必要がある。

* **実行基盤 (uCosminexusClient) のバージョンアップに伴う影響調査**
    CB アドインの動作前提となる uCosminexusClient のバージョン V9 から V11 への変更により、上位アプリケーション (CB アドイン) に影響を与える可能性を調査する。
* **Java11 コンパイラでの影響調査**
    CB アドインのソースコードに対して Java11 環境でコンパイルを実施し、コンパイルエラー、警告の内容を確認し、修正が必要な箇所を特定する。
* **外部ライブラリ (OSS) の Java11 対応状況に関する影響調査**
    CB アドインが依存している外部 OSS ライブラリを洗い出し、各ライブラリの Java11 対応版の有無、バージョンアップに伴う API 変更の有無、セキュリティ脆弱性対応版への更新要否を確認する。

### 4.2 調査方法
4.1 調査方針で決めた方針に基づき、本章で詳細な調査方法について示す。

#### 4.2.1 uCosminexusClient リリースノート調査

**調査対象の決定**
uCosminexusClient のリリースノートの内、ベースとしている JDK が 7 ～ 11(最新版) までを調査対象とした。

**調査方法**
uCosminexusClient の変更項目が CB アドインに影響する可能性があるかを以下の方法で調べた。
1.  リリースノートの「修正内容」から、CB アドインに影響しうる問題を以下の 2 つの文言をもとに抽出。
    「上位アプリケーションへの影響」、「API の仕様変更」等の記載内容
2.  ①で抽出した修正に対し、リリースノートに記載されたクラスやメソッドを CB アドインソースコード内で grep 検索し、該当クラス・メソッドを使用しているか確認する。
3.  技術要素で判断基準が示されている場合は思い込みで誤らないように、当該技術要素を調査し影響有無の点検を行った。

#### 4.2.2 コンパイルエラー調査

**調査方法**
JRE11 でコンパイルを実施。発生するエラー・警告を抽出し、原因を調査する。

#### 4.2.3 OSS 調査

**調査方法**
1.  CB アドインの全ソースファイルの import 文 grep 検索し、使用しているライブラリを洗い出す。
2.  ①で洗い出したライブラリの内、Java標準ライブラリとOSSライブラリを切り分ける。
3.  使用しているOSSライブラリがあれば、コード内の利用箇所を特定し、各使用方法がJava11の仕様に準拠しているかを確認する。

### 4.3 調査結果

#### 4.3.1 uCosminexusClient リリースノート調査結果
調査対象となったのは 3 種類の型番 (P-2443-7H94, P-2943-7HB4, P-2943-7HY4) で、各型番には複数バージョンが含まれ、合計 31 バージョンのリリースノートを確認した。調査結果は以下の通りで、対策要項目は0件であった。

**表 4.3.1 uCosminexusClient リリースノート調査結果**

| 型番 | 対象リリースノート数 | 総項目数 | 対策要項目数 |
| :--- | :--- | :--- | :--- |
| P-2443-7H94 | 6 | 213 | 0 |
| P-2943-7HB4 | 10 | 193 | 0 |
| P-2943-7HY4 | 15 | 147 | 0 |
| 合計 | 31 | 553 | 0 |

#### 4.3.2 コンパイルエラー調査結果
JRE11 でコンパイル時に発生したエラー・警告を表 4.3.2 に示す。
問題の原因を分類すると、以下の 3 種類であった。

1.  Java11 非対応 API の使用
2.  デコンパイル時にコード構造の崩れたこと
3.  開発時より存在していた警告

このうち、3. 開発時から存在していた警告は、当初の設計思想に基づくものであるため修正は行わず、1. と 2. の項目のみ対策要項目とした。

**表 4.3.2 コンパイルエラー調査結果**

| # | 問題種別 | エラー内容 | 原因 | 分類 | 項目数 | 対策要項目数 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 1 | エラー | case 式は定数式でなければなりません | enum 定数への参照が適切に解決されていない | **🔴デコンパイル起因** | 3 | 3 |
| 2 | 警告 | getModifiers() は非推奨になっています。 | Java 9 で非推奨化された API の使用 | **🔴Java 11 非推奨** | 2 | 2 |
| 3 | 警告 | enum スイッチで対応する case ラベルが必要です。 | switch 文で enum 値の網羅性不足 | **🔴デコンパイル起因** | 1 | 1 |
| 4 | 警告 | JComboBox は raw 型です。 | ジェネリクス型パラメータの未指定 | **🔴既存警告** | 3 | 0 |
| 5 | 警告 | List は raw 型です。 | Map<String, List<Element>>が反映されていない | **🔴既存警告** | 1 | 0 |
| 6 | 警告 | デッド・コード | 到達不可能なコード | **🔴既存警告** | 1 | 0 |
| 7 | 警告 | フィールド ○○○○ の値は使用されていません | 定数フィールドが実際のコード内で参照されていない | **🔴既存警告** | 12 | 0 |
| 8 | 警告 | リソース・リーク: Closeable が閉じられることはありません | リソース管理の問題 | **🔴デコンパイル起因** | 2 | 2 |
| | | **合計** | | | **25** | **8** |

#### 4.3.3 OSS (オープンソースソフトウェア) 調査結果
全ソースファイルの import 文を調査した結果、使用しているライブラリは表 4.3.3 のように Java 標準ライブラリのみで、OSS は使用していないことが分かった。
Java 標準ライブラリは外部 OSS に依存しないため追加の対応は不要である。

**表 4.3.3 OSS 調査結果**

| ライブラリ種別 | 項目数 | 対策要項目数 |
| :--- | :--- | :--- |
| Java 標準ライブラリ | 144 | 0 |
| OSS ライブラリ | 0 | 0 |
| 合計 | 144 | 0 |

#### 4.3.4 調査結果のまとめ
調査の結果、合計25件のエラー・警告が抽出されましたが、このうち**対応が必要な項目は8件**でした。

* **対応不要 (0件):** uCosminexusClientのバージョンアップ、外部OSSライブラリの依存性、開発時から存在した軽微な警告については、いずれも対応不要と判断しました。
* **対応必要 (8件):** Javaの非推奨API使用（2件）と、デコンパイル時に発生した構造的なエラー（6件）について修正対応が必要と特定しました。

---

### 4.4 影響範囲および対応方法

本章では、4.3 調査結果で特定した**対策要項目 8 件**に対する対応方法を示します。

#### 4.4.1 対策が必要な課題の構造

対策が必要な8項目は、大きく分けて以下の2つの課題に分類されます。

1.  **Javaの非推奨APIの使用 (2件)**: `InputEvent.getModifiers()`の使用。Java 9以降で非推奨となったため、`getModifiersEx()`への置き換えが必須です。
2.  **デコンパイル起因のコード構造破損 (6件)**: コードの復元過程で生じた、enumの参照解決エラーやリソースリーク警告などの構造的な問題。

**対応方針：** 全ての項目（8件）について、互換性維持とコンパイルエラー解消のため修正を実施します。

#### 4.4.2 全対策要項目 (8件) の修正方針

| # | 分類 | 対策要項目数 | 修正方針 |
| :--- | :--- | :--- | :--- |
| **1, 3, 8** | **デコンパイル起因** | 6 | **デコンパイル起因のコード修正:** デコンパイル時に失われたコード構造を復元する。具体的には、enum定数への**型キャストを追加**、switch文の**enum値を網羅**する。また、リソースリーク警告を解消するため、`finally`ブロックなどで**Closeableオブジェクトを明示的に閉じる**処理を追記する。 |
| **2** | **Java 11 非推奨** | 2 | **Java APIの置き換え:** 非推奨の`InputEvent.getModifiers()`を、推奨されている**`getModifiersEx()`**に置き換える。Shiftキーの判定にはビットマスク演算子（`&`）を使用するようコードを修正する。 |

# FREIA21+ Contents Builder アドイン 作業内容書
... (中略: 1章から4.4.3までは変更なし) ...

#### 4.4.3 具体的修正内容（8項目すべて） (🔴具体的なコードを記述)

全8項目に対する具体的な修正を以下にまとめます。

| 課題分類 | 修正内容（具体的なコード例で） | 対象クラス例 |
| :--- | :--- | :--- |
| **Java 11 非推奨 (2件)** | 非推奨APIの置き換え: <br> **変更前:** `e.getModifiers() == 0` <br> **変更後:** `e.getModifiersEx() == 0` <br><br> **変更前:** `e.getModifiers() == 1` <br> **変更後:** `(e.getModifiersEx() & java.awt.event.InputEvent.SHIFT_DOWN_MASK) != 0` | **AddInTable.java** |
| **デコンパイル起因 (4件)**<br>(case式エラー, enumラベル不足) | enum定数エラーと網羅性対応: <br> **変更前:** `case MY_ENUM.VALUE:` <br> **変更後:** `case ((MY_ENUM)MY_ENUM.VALUE):` <br> (※該当箇所に**defaultラベル**を追記し、網羅性エラーを解消) | **AddInDialog.java**, **AddInTable.java** |
| **デコンパイル起因 (2件)**<br>(リソースリーク警告) | リソース解放処理の追記: <br> **変更前:** `FileInputStream fis = new FileInputStream(file);` <br> **変更後:** `try (FileInputStream fis = new FileInputStream(file)) { ... }` <br> (※または、`finally`句で`fis.close()`を呼び出す。) | **AddInManager.java**, **Utility.java** |

#### 4.4.3 具体的修正内容（8項目すべて） (🔴具体的なコードを記述)

全8項目に対する具体的な修正を以下にまとめます。

| 課題分類 | 修正内容（具体的なコード例で） | 対象クラス例 |
| :--- | :--- | :--- |
| **Java 11 非推奨 (2件)** | 非推奨APIの置き換え: <br> **変更前:** `e.getModifiers() == 0` <br> **変更後:** `e.getModifiersEx() == 0` <br><br> **変更前:** `e.getModifiers() == 1` <br> **変更後:** `(e.getModifiersEx() & java.awt.event.InputEvent.SHIFT_DOWN_MASK) != 0` | **AddInTable.java** |
| **デコンパイル起因 (4件)**<br>(case式エラー, enumラベル不足) | enum定数エラーと網羅性対応: <br> **変更前:** `case MY_ENUM.VALUE:` <br> **変更後:** `case ((MY_ENUM)MY_ENUM.VALUE):` <br> (※該当箇所に**defaultラベル**を追記し、網羅性エラーを解消) | **AddInDialog.java**, **AddInTable.java** |
| **デコンパイル起因 (2件)**<br>(リソースリーク警告) | リソース解放処理の追記: <br> **変更前:** `FileInputStream fis = new FileInputStream(file);` <br> **変更後:** `try (FileInputStream fis = new FileInputStream(file)) { ... }` <br> (※または、`finally`句で`fis.close()`を呼び出す。) | **AddInManager.java**, **Utility.java** |

#### 4.4.4 修正に対する影響範囲の確認 🔨

上記対応方法で示したコードの修正が、**アドインの他の機能や、外部のプログラムに悪影響を与えないこと**を調査し、確認しました。

**調査方法**
1.  修正を行ったクラス（AddInTable.java、AddInDialog.javaなど）を特定します。
2.  そのクラスが他のクラスとどのように繋がっているか（呼び出されているか、データを渡しているか）を確認します。
3.  修正されたコード（特にJava APIの置き換え部分）が、**そのクラスの内部処理だけで完結しているか**を確認します。

**調査結果**
| 修正項目 | 修正内容と影響範囲 | 影響の有無 |
| :--- | :--- | :--- |
| **Java API置き換え** (`getModifiers()` → `getModifiersEx()`) | 修正は**AddInTable.java**内のキーボードイベント処理に限定されており、この処理の結果が外部に影響を与えることはありません。キー判定の仕組みを変えただけで、データの入出力には関わりません。 | **影響なし** |
| **デコンパイル起因の修正** (型キャスト、リソース解放、switch文の修正) | これらはすべて、**Java 11 コンパイラのエラーや警告を解消するための文法的な修正**です。既存のビジネスロジック（データの処理手順）自体は変更していません。このため、他の機能への影響は発生しません。 | **影響なし** |

結論として、今回の8件のコード修正は、いずれも**既存機能の動作に影響を及ぼすことなく、Java 11 環境への対応を完了できる**ことが確認されました。
---

## 5 サーバ取引構成定義編集
本章では、CB アドインのサーバ取引構成定義編集機能の Java11 化・Win11 化による影響調査の内容を示す。
... (以下、変更なし) ...
---

## 5 サーバ取引構成定義編集
本章では、CB アドインのサーバ取引構成定義編集機能の Java11 化・Win11 化による影響調査の内容を示す。

### 5.1 調査方針
サーバ取引構成定義編集機能は ExcelVBA マクロを使ったツールであり、今回の更改では Excel のバージョンは現行と同じ「2021 LTSC」を使用する。Excel のバージョンが変わらない場合、通常は VBA の動作も同じであるためコードの変更は必要ない。そのため Windows11 で現行環境と同様に問題なく動作することを確認する。

**表 5.1 現行環境と次期環境での OS および Excel のバージョン**

| 項目 | 現行環境 | 次期環境 |
| :--- | :--- | :--- |
| OS バージョン | Windows10 Pro (64bit) | Windows11 |
| Excel バージョン | Excel 2021 LTSC | Excel 2021 LTSC |

### 5.2 調査方法
Windows11 環境でサーバ取引構成定義作成ツールを操作し、以下の手順で動作確認をする。

* **新規作成する場合**
    1.  サーバ取引構成定義編集マクロツール(tran-def.xls)を起動。
    2.  各種設定値を編集できることを確認。
    3.  アドインタブ内「サーバ定義ファイルを保存する」からサーバ定義ファイルを保存できることを確認。
    4.  保存したファイルの設定項目の変更が反映されていることを確認。

* **既存ファイルを編集する場合**
    1.  サーバ取引構成定義編集マクロツール(tran-def.xls)を起動し、アドインタブ内「定義ファイルを開く」から取引定義ファイルが開けることを確認。
    2.  アドインタブ内「サーバ定義ファイルを開く」からサーバ取引定義ファイルが開けることを確認。
    3.  以下の 2 つの場合について確認。
        * ③-1 各設定値を変更し、アドインタブ内「サーバ定義ファイルを保存する」からサーバ定義ファイルを保存できることを確認。
        * ③-2 各設定値を変更せず、アドインタブ内「サーバ定義ファイルを保存する」からサーバ定義ファイルを保存できることを確認。

### 5.3 調査結果
上記はテスト工程にて実施。
